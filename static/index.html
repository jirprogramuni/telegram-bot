<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мои Смены</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; margin: 0; }
    .header { text-align: center; margin-bottom: 20px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .day-name { background: #eee; padding: 10px; text-align: center; font-weight: bold; border-radius: 8px; font-size: 14px; }
    .day { background: white; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 16px; }
    .day.has-shift { background: #c8e6c9; }
    .day.today { background: #e3f2fd; font-weight: bold; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
    input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    .btn { background: #0088cc; color: white; border: none; cursor: pointer; font-weight: bold; }
    .btn-close { background: #ddd; color: #333; }
    .loading { text-align: center; padding: 20px; font-size: 18px; color: #666; }
  </style>
</head>
<body>
  <div class="header">
    <h2>Мои Смены</h2>
    <p>ID: <span id="user-id">загрузка...</span></p>
  </div>
  <div id="loading" class="loading">Загрузка...</div>
  <div id="calendar" style="display: none;"></div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="title">Новая смена</h3>
      <input type="hidden" id="date">
      <select id="point">
        <option value="">Выберите заведение</option>
        <option>КУЧИНО</option>
        <option>РЕУТОВ (Победы)</option>
        <option>ЛЕНИНА</option>
        <option>НЯМС</option>
        <option>РЕУТОВ (Юбилейный)</option>
      </select>
      <input id="in" placeholder="Приход (09:00)" maxlength="5">
      <input id="out" placeholder="Уход (18:00)" maxlength="5">
      <button class="btn" onclick="save()">Сохранить</button>
      <button class="btn btn-close" onclick="closeM()">Отмена</button>
    </div>
  </div>

  <script>
    // ДЕБАГ: ПОКАЗЫВАЕМ LOG В ALERT
    console.log = (msg) => window.Telegram.WebApp.showAlert('[LOG] ' + msg);
    console.error = (msg) => window.Telegram.WebApp.showAlert('[ERROR] ' + msg);
    console.log('JS загружен');

    const BACKEND = 'https://telegram-bot-1-ydll.onrender.com';
    let userId = 'unknown';
    let month = new Date();
    let shifts = {};

    console.log('WebApp ready');
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();

    if (window.Telegram.WebApp.initDataUnsafe.user) {
      userId = window.Telegram.WebApp.initDataUnsafe.user.id;
      console.log('ID получен: ' + userId);
    } else {
      console.error('ID не получен');
    }
    document.getElementById('user-id').innerText = userId;

    const cal = document.getElementById('calendar');
    const loading = document.getElementById('loading');

    function render() {
      console.log('Рендерим календарь');
      cal.innerHTML = '';
      const y = month.getFullYear(), m = month.getMonth();
      const firstDay = new Date(y, m, 1).getDay();
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const start = firstDay === 0 ? 6 : firstDay - 1;

      ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(d => {
        const el = document.createElement('div');
        el.className = 'day-name';
        el.innerText = d;
        cal.appendChild(el);
      });

      for (let i = 0; i < start; i++) {
        const el = document.createElement('div');
        el.className = 'day';
        cal.appendChild(el);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const date = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const el = document.createElement('div');
        el.className = 'day';
        if (shifts[date]) el.classList.add('has-shift');
        if (d === new Date().getDate() && m === new Date().getMonth() && y === new Date().getFullYear()) {
          el.classList.add('today');
        }
        el.innerText = d;
        el.onclick = () => openModal(date, shifts[date]);
        cal.appendChild(el);
      }

      loading.style.display = 'none';
      cal.style.display = 'grid';
      console.log('Рендер завершен');
    }

    async function load() {
      loading.style.display = 'block';
      cal.style.display = 'none';
      const y = month.getFullYear();
      const m = String(month.getMonth() + 1).padStart(2, '0');
      console.log('Запрос смен: ' + BACKEND + '/get-shifts?user_id=' + userId + '&month=' + y + '-' + m);
      try {
        const res = await fetch(`${BACKEND}/get-shifts?user_id=${userId}&month=${y}-${m}`);
        console.log('Ответ: ' + res.status);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        shifts = data.shifts || {};
        console.log('Смены: ' + JSON.stringify(shifts));
      } catch (e) {
        console.error('Ошибка: ' + e.message);
        shifts = {};
      }
      render();
    }

    function openModal(date, s) {
      console.log('Открываем модал для даты: ' + date);
      document.getElementById('date').value = date;
      document.getElementById('title').innerText = s ? 'Редактировать' : 'Новая смена';
      document.getElementById('point').value = s?.point || '';
      document.getElementById('in').value = s?.time_in || '';
      document.getElementById('out').value = s?.time_out || '';
      document.getElementById('modal').style.display = 'flex';
    }

    function closeM() {
      console.log('Закрываем модал');
      document.getElementById('modal').style.display = 'none';
    }

    async function save() {
      const date = document.getElementById('date').value;
      const point = document.getElementById('point').value;
      const tin = document.getElementById('in').value.trim();
      const tout = document.getElementById('out').value.trim();
      console.log('Сохранение: ' + date + ', ' + point + ', ' + tin + ', ' + tout);
      if (!point || !tin || !tout) return alert('Заполни всё!');
      const [h1, m1] = tin.split(':').map(Number);
      const [h2, m2] = tout.split(':').map(Number);
      let hours = (h2 * 60 + m2 - h1 * 60 - m1) / 60;
      if (hours <= 0) hours += 24;
      if (hours <= 0 || hours > 24) return alert('Неверное время');
      try {
        const res = await fetch(`${BACKEND}/save-shift`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegram_id: userId,
            date,
            point,
            time_in: tin,
            time_out: tout,
            total_hours: hours.toFixed(1)
          })
        });
        console.log('Ответ сохранения: ' + res.status);
        const result = await res.json();
        if (result.success) {
          closeM();
          load();
        } else {
          alert(result.error || 'Ошибка');
        }
      } catch (e) {
        console.error('Ошибка сохранения: ' + e.message);
        alert('Нет связи');
      }
    }

    document.querySelector('h2').onclick = () => {
      console.log('Следующий месяц');
      month = new Date(month.getFullYear(), month.getMonth() + 1);
      load();
    };

    load();
  </script>
</body>
</html>